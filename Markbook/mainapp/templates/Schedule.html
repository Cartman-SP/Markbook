{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="{% static 'css/schedule.css' %}" />
    <meta charset="UTF-8" />
    <title>Schedule</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="content">
      <div class="header">
        <h1>Расписание</h1>
        <div class="user">
          <h3>{{username}}</h3>
          <a href="#">
            <img
              id="leave"
              src="https://img.icons8.com/ios-glyphs/30/FF2B2B/door-opened.png"
              alt="door"
            />
          </a>
        </div>
      </div>
      <div class="calendar">
        <div class="day" id="week" onclick="weekchange(-7)">
          <h4><</h4>
        </div>
        <div class="day" id="Mon" onclick="choose(this)">
          <p>Пн</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Tue" onclick="choose(this)">
          <p>Вт</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Wed" onclick="choose(this)">
          <p>Ср</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Thu" onclick="choose(this)">
          <p>Чт</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Fri" onclick="choose(this)">
          <p>Пт</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Sat" onclick="choose(this)">
          <p>Сб</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="Sun" onclick="choose(this)">
          <p>Вс</p>
          <h4></h4>
          <h3 visibility: hidden>12312</h3>
        </div>
        <div class="day" id="week" onclick="weekchange(7)">
          <h4>></h4>
        </div>
      </div>
      <div class="lessons-content">
        <div class="lesson">
          <div class="naming">
            <p>8.30 - 10.10</p>
            <h4>Мат. Анализ</h4>
          </div>
          <div class="arrow-button"></div>
        </div>
        <div class="lesson">
          <div class="naming">
            <p>10.20 - 12.00</p>
            <h4>ОРГ</h4>
          </div>
          <div class="arrow-button"></div>
        </div>
        <div class="lesson">
          <div class="naming">
            <p>12.20 - 14.00</p>
            <h4>Программирование</h4>
          </div>
          <div class="arrow-button"></div>
        </div>
      </div>
    </div>

    <script>
      var CSRF_TOKEN = "{{ csrf_token }}";
      var today = new Date();
      var week = [
        document.getElementById("Mon"),
        document.getElementById("Tue"),
        document.getElementById("Wed"),
        document.getElementById("Thu"),
        document.getElementById("Fri"),
        document.getElementById("Sat"),
        document.getElementById("Sun"),
      ];


      function weekchange(i){
          newb = document.getElementsByClassName('active-day')[0];
          var nextWeek = new Date(today);
          nextWeek.setDate(today.getDate() + i);
          today = nextWeek;
          onPageLoad();
          oldb = document.getElementsByClassName("active-day")[0];
          oldb.classList.remove("active-day");
          oldb.classList.add("day");
          newb.classList.remove("day");
          newb.classList.add("active-day");
      }

      function onPageLoad() {
        var c = 1
        for (let i = today.getDay(); i < 7; i++) {
          var h = week[i].getElementsByTagName("h4")[0];
          var nextDay = new Date(today);
          nextDay.setDate(today.getDate() + c);
          var p = week[i].getElementsByTagName("h3")[0];
          p.innerHTML = `${nextDay.getDate()}/${nextDay.getMonth() + 1}/${nextDay.getFullYear()}`;
          h.innerHTML = nextDay.getDate();
          c = c+1;
        }
        var c = 1
        for (let i = today.getDay(); i >= 0; i--) {
          var h = week[i].getElementsByTagName("h4")[0];
          var nextDay = new Date(today);
          nextDay.setDate(today.getDate() + c);
          var p = week[i].getElementsByTagName("h3")[0];
          p.innerHTML = `${nextDay.getDate()}.${nextDay.getMonth() + 1}.${nextDay.getFullYear()}`;
          h.innerHTML = nextDay.getDate();
          c = c-1;
        }

        var week2 = [
          document.getElementById("Sun"),
          document.getElementById("Mon"),
          document.getElementById("Tue"),
          document.getElementById("Wed"),
          document.getElementById("Thu"),
          document.getElementById("Fri"),
          document.getElementById("Sat"),
        ];
        week2[today.getDay()].classList.remove("day");
        week2[today.getDay()].classList.add("active-day");
        gettable(week2[today.getDay()].getElementsByTagName("h3")[0].innerHTML,week2[today.getDay()].getElementsByTagName("p")[0].innerHTML);
      }
      window.onload = onPageLoad;

      function gettable(dater,dayer) {
        var xmlhttp = new XMLHttpRequest();
        var theUrl = "get_table/";

          xmlhttp.onload = function () {
            if (xmlhttp.status == 200) {
              var responseText = xmlhttp.responseText;
              var context = JSON.parse(responseText);
              document.getElementsByClassName("lessons-content")[0].innerHTML = ''
              for(var i in context){
                var div = document.createElement("div");
                console.log(context[i])
                div.innerHTML = `
                                  <div class="lesson">
                                    <div class="naming">
                                      <p>${context[i].time}</p>
                                      <h4>${context[i].name}</h4>
                                    </div>
                                    <div class="arrow-button"></div>
                                  </div>
                                `;
                console.log(div.innerHTML)
                document.getElementsByClassName("lessons-content")[0].appendChild(div);
              }
          }
  };
        xmlhttp.open("POST", theUrl, (async = true));
        xmlhttp.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
        xmlhttp.send(JSON.stringify({ date: dater, day: dayer }));
      }

      function choose(newb) {
        oldb = document.getElementsByClassName("active-day")[0];
        oldb.classList.remove("active-day");
        oldb.classList.add("day");
        newb.classList.remove("day");
        newb.classList.add("active-day");
        gettable(newb.getElementsByTagName("h3")[0].innerHTML,newb.getElementsByTagName("p")[0].innerHTML);
        
      }
    </script>
  </body>
</html>
